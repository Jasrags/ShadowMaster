---
name: M0.3.9 Free Skills Implementation
overview: Implement tracking and allocation of free skills from priority table in SkillsStep. Free skills come from Magic/Resonance priority selections (e.g., Priority A Magician gets 2 magical skills at rating 5 for free). These must be tracked separately from regular skill points and displayed clearly in the UI.
todos: []
---

# M0.3.9: Free Skills from Priority Implementation

## Overview

Implement tracking and allocation of free skills granted by Magic/Resonance priority selections. These free skills are separate from the regular skill points allocated by the Skills priority column. For example:

- Priority A Magician/Mystic Adept: 2 magical skills at rating 5 (free)
- Priority B Adept: 1 active skill at rating 4 (free)
- Priority B Aspected Mage: 1 magical skill group at rating 4 (free)
- Priority C Adept: 1 active skill at rating 2 (free)
- Priority C Aspected Mage: 1 magical skill group at rating 2 (free)

## Implementation Tasks

### 1. Extend Type Definitions

**File:** `lib/types/character.ts`

Add source tracking to skills:

- Add optional `source` field to track skill origin: `"free" | "priority" | "karma"`
- Skills from priority free skills should have `source: "free"`
- Skills purchased with skill points should have `source: "priority"` (or undefined for backward compatibility)
- Skills purchased with karma should have `source: "karma"`

**File:** `lib/types/creation.ts`

Add structure to track free skill allocations in `CreationState`:

- Add `freeSkillAllocations?: FreeSkillAllocation[]` to `CreationState.selections`
- Define `FreeSkillAllocation` interface:
  ```typescript
  interface FreeSkillAllocation {
    type: "magical" | "resonance" | "active" | "magicalGroup";
    rating: number;
    count: number;
    allocated: Array<{
      skillId?: string; // For individual skills
      groupId?: string; // For skill groups
      rating: number;
    }>;
  }
  ```


### 2. Extract Free Skills from Priority Table

**File:** `app/characters/create/components/CreationWizard.tsx`

In the `budgetValues` useMemo (around line 131), extract free skills data:

- Check if magic priority is set
- Get selected magical path from `state.selections["magical-path"]`
- Look up free skills from priority table: `priorityTable.table[magicPriority].magic.options[path].freeSkills`
- Store in a new budget value key like `"free-skills"` or add to `state.selections`

**Alternative approach:** Calculate free skills in SkillsStep component itself by reading from priority table and state.

### 3. Update SkillsStep Component

**File:** `app/characters/create/components/steps/SkillsStep.tsx`

#### 3.1 Add Free Skills Calculation

- Add useMemo to calculate available free skills from priority table
- Read `state.priorities.magic` and `state.selections["magical-path"]`
- Extract `freeSkills` array from priority table
- Calculate remaining free skill allocations (total - allocated)

#### 3.2 Track Free Skill Allocations

- Add state tracking for which skills/groups have been allocated free ratings
- Store in `state.selections.freeSkillAllocations` or similar
- Track: skill/group ID, rating allocated, whether fully allocated

#### 3.3 Update Skill Point Calculations

- Modify `skillPointsSpent` calculation to exclude free skill ratings
- Add separate tracking for free skill allocations vs purchased skills
- Update `skillPointsRemaining` to only count purchased skills

#### 3.4 Add Free Skills UI Section

- Display available free skill allocations at top of Active Skills tab
- Show format: "2 magical skills at rating 5 (0 allocated)" or similar
- Add selection UI for allocating free skills:
  - For magical/resonance skills: Show filtered list of applicable skills
  - For active skills: Show all active skills
  - For skill groups: Show applicable skill groups
- Allow user to select which specific skills/groups get the free ratings
- Show visual distinction (badge/color) for skills with free ratings

#### 3.5 Update Skill Display

- In `renderSkill()`, show if skill has free rating (badge/indicator)
- Display effective rating (free rating + purchased rating)
- Ensure free ratings don't consume skill points when displayed

#### 3.6 Update Skill Change Handlers

- Modify `handleSkillChange()` to:
  - Check if skill has free rating
  - If increasing above free rating, consume skill points
  - If decreasing below free rating, track that free rating is still allocated
  - Update free skill allocation tracking
- Ensure free ratings are preserved when skill is modified

### 4. Update State Management

**File:** `app/characters/create/components/steps/SkillsStep.tsx`

When updating state:

- Track free skill allocations in `state.selections.freeSkillAllocations`
- When allocating a free skill, add entry to allocations array
- When removing a free skill allocation, remove from array
- Ensure free skills are stored in `state.selections.skills` with appropriate source tracking

### 5. Validation

**File:** `app/characters/create/components/steps/SkillsStep.tsx`

Add validation:

- Ensure all required free skill allocations are completed before step completion
- Validate that free skill ratings don't exceed maximums
- Ensure free skills match the type requirement (magical skills for magical, etc.)

### 6. Data Persistence

**File:** `lib/types/character.ts` (for final character)

When finalizing character:

- Store free skill allocations in character data
- Include source tracking in skills object
- This enables future features like karma tracking and character advancement

## Key Implementation Details

### Free Skills Data Structure (from priority table)

```json
{
  "type": "magical" | "resonance" | "active" | "magicalGroup",
  "rating": 5,
  "count": 2
}
```

### State Tracking

- Free skill allocations should be stored in `CreationState.selections`
- Format: Array of allocations with skill/group IDs and ratings
- Skills in `state.selections.skills` should track their source

### UI Flow

1. User sees available free skill allocations at top of SkillsStep
2. User selects which skills/groups to allocate free ratings to
3. Selected skills show free rating badge/indicator
4. User can then spend regular skill points on top of free ratings
5. Free ratings are clearly distinguished from purchased ratings

## Testing Considerations

- Test with Priority A Magician (2 magical skills at rating 5)
- Test with Priority B Adept (1 active skill at rating 4)
- Test with Priority B Aspected Mage (1 magical group at rating 4)
- Test that free skills don't consume skill points
- Test that free skills can be increased with skill points
- Test that removing a free skill allocation works correctly
- Test edge cases: changing magical path, changing priorities mid-creation

## Files to Modify

1. `lib/types/character.ts` - Add source tracking to skills
2. `lib/types/creation.ts` - Add FreeSkillAllocation interface
3. `app/characters/create/components/steps/SkillsStep.tsx` - Main implementation
4. `app/characters/create/components/CreationWizard.tsx` - Possibly extract free skills data (optional)

## Dependencies

- Priority table data structure (already exists in `data/editions/sr5/core-rulebook.json`)
- Magic path selection (already handled in MagicStep)
- Skills data structure (already exists)