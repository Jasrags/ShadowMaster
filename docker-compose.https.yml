version: "3.8"

# Shadow Master with HTTPS via Caddy reverse proxy
#
# This compose file adds Caddy as a reverse proxy with automatic SSL
# certificates via Let's Encrypt DNS-01 challenge (Cloudflare).
#
# Prerequisites:
#   1. Cloudflare account with domain added
#   2. Cloudflare API token with Zone:DNS:Edit permission
#   3. Router port forwarding: 9443 -> server:9443
#
# Usage:
#   docker compose -f docker-compose.https.yml up -d
#
# See: docs/decisions/012-deployment.https-reverse-proxy.md

services:
  # Caddy reverse proxy with automatic HTTPS
  caddy:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    # Alternative: use pre-built image
    # image: ghcr.io/slothcroissant/caddy-cloudflaredns:latest
    container_name: caddy-proxy
    restart: unless-stopped
    ports:
      - "${HTTPS_PORT:-9443}:${HTTPS_PORT:-9443}"
      - "${HTTP_PORT:-3000}:${HTTP_PORT:-3000}"
    environment:
      - CF_API_TOKEN=${CF_API_TOKEN}
      - DOMAIN=${DOMAIN:-home.jasrags.net}
      - HTTPS_PORT=${HTTPS_PORT:-9443}
      - HTTP_PORT=${HTTP_PORT:-3000}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      shadow-master:
        condition: service_healthy
    networks:
      - shadow-master-network
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Shadow Master application
  shadow-master:
    image: ghcr.io/jasrags/shadowmaster:latest
    container_name: shadow-master-app
    restart: unless-stopped
    # No external port exposure - only accessible via Caddy
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
    volumes:
      - shadow-master-data:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - shadow-master-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Watchtower for automatic updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/config.json:ro
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

networks:
  shadow-master-network:
    driver: bridge

volumes:
  shadow-master-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
