# Caddyfile for Shadow Master HTTPS Reverse Proxy
#
# This configuration uses DNS-01 challenge via Cloudflare for SSL certificates,
# allowing HTTPS on non-standard ports when ISP blocks 80/443.
#
# Required environment variables:
#   CF_API_TOKEN - Cloudflare API token with Zone:DNS:Edit permission
#   DOMAIN       - Domain name (default: home.jasrags.net)
#   HTTPS_PORT   - HTTPS port (default: 9443)
#
# See: docs/decisions/012-deployment.https-reverse-proxy.md

{
	# Use DNS challenge since ports 80/443 are blocked by ISP
	acme_dns cloudflare {env.CF_API_TOKEN}
}

# HTTPS endpoint on custom port
https://{$DOMAIN:home.jasrags.net}:{$HTTPS_PORT:9443} {
	reverse_proxy shadow-master:3000

	# Security headers
	header {
		# HSTS - Force HTTPS for 1 year
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"
		# Control referrer information
		Referrer-Policy "strict-origin-when-cross-origin"
		# Remove server identification
		-Server
	}

	# Logging
	log {
		output stdout
		format console
	}
}

# Optional HTTP endpoint (can be removed for HTTPS-only deployment)
# Comment out or remove this block when ready for HTTPS-only
http://{$DOMAIN:home.jasrags.net}:{$HTTP_PORT:3000} {
	reverse_proxy shadow-master:3000

	log {
		output stdout
		format console
	}
}
