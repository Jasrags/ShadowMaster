services:
  shadow-master:
    build:
      context: .
      dockerfile: Dockerfile
    image: shadow-master:local
    container_name: shadow-master-app
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Email configuration for local development
      - EMAIL_TRANSPORT=smtp
      - EMAIL_FROM=noreply@shadowmaster.local
      - EMAIL_FROM_NAME=Shadow Master
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - SMTP_SECURE=false
    restart: unless-stopped
    volumes:
      - shadow-master-data:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - shadow-master-network
    depends_on:
      - mailpit

  # Mailpit - Email testing server for local development
  # Web UI: http://localhost:8025
  # SMTP: localhost:1025
  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP
    environment:
      - MP_SMTP_AUTH_ACCEPT_ANY=true
      - MP_SMTP_AUTH_ALLOW_INSECURE=true
      - MP_MAX_MESSAGES=500
    networks:
      - shadow-master-network
    restart: unless-stopped

networks:
  shadow-master-network:
    driver: bridge

volumes:
  shadow-master-data:
    driver: local
